/* representation of a score matrix (i.e. BLOSUM) for sequence alignment;
   score matrix can be read from file and can be accessed with
   score (char a, char b) to get the scoring value of a and b;
   the score function and storage of matrix is case insensitive
*/

#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <ctype.h>
#include <limits.h>

#include "pssm.h"

#define LINE 1024

static Pssm* initialize_pssm (int m, int n)
{
  int i,j;
  Pssm* pssm = malloc(sizeof(Pssm));
  int** matrix = (int**) malloc(m*sizeof(int*));
  int* row;

  // reserve memory as one block
  row = (int*) malloc(m*n*sizeof(int));
  for (i = 0; i < m; i++)
  {
    matrix[i] = &row[i*n];
    for (j = 0; j < n; j++)
    {
      matrix[i][j] = INT_MIN;
    }
  }

  int* maxscore = malloc(n*sizeof(int));
  pssm->maxscore = maxscore;
  pssm->m = m;
  pssm->n = n;
  pssm->matrix = matrix;
  return pssm;
}

void delete_pssm(Pssm* pssm)
{
  if (pssm == NULL)
    return;

  // matrix[0] contains pointer to reserved memory block
  free(pssm->matrix[0]);
  free(pssm->matrix);
  free(pssm->maxscore);
  free(pssm);
}

static void max_pssmscore (Pssm* pssm)
{
  int i,j,sc;

  for (i = 0; i < pssm->n; i++)
  {
    pssm->maxscore[i] = INT_MIN;
    for (j = 0; j < pssm->m; j++)
    {
      if ((sc = get_pssmscore(pssm, i, j+'A')) > pssm->maxscore[i])
      {
        pssm->maxscore[i] = sc;
      }
    }
  }
}

inline int get_pssmmaxscore(Pssm* pssm, int d)
{
  return pssm->maxscore[d];
}

inline int get_pssmscore (Pssm* pssm, int d, char b)
{
  b = toupper(b);

  if (b == '*')
    b = '[';

  int score;

  if (d < 0 || d >= pssm->n)
  {
    fprintf(stderr, "ERROR: %d out of range!\n", d);
    return INT_MIN;
  }

  if (!isupper(b) && b != '[')
  {
    printf("ERROR: %c is not an allowed character!\n",b);
    return INT_MIN;
  }

  score = pssm->matrix[b-'A'][d];
  if (score == INT_MIN)
  {
    ;//printf("ERROR: exchange from %c and %c is not defined!\n", a, b);
  }
  return score;
}

// read scorematrix from file
Pssm* read_pssm (char* filename)
{
  char ch;
  char line[LINE];
  // open file
  FILE * filestream = fopen (filename, "rt");
  char *wordptr;
  int score;
  int i = 0;
  int len = 0;
  int linecount = 0;
  int* usedrow;
  Pssm* pssm;

  // if opening of file failes
  if (filestream == NULL)
  {
    printf("ERROR: could not open file %s!\n", filename);
    return NULL;
  }

  // initialize allscorematrix (with A-Z) und *
  // * will be replaced by [ (following Z)
  usedrow = calloc(27,sizeof(int));

  /* read first non empty line to determine length of PSSM */
  while (fgets(line, LINE, filestream) != NULL)
  {

    if (line[0] != '\n' && line[0] != '#')
    {
      line[strlen(line)-1] = '\0'; // remove trailing \n
      // split line at blank
      wordptr = strtok(line, " ");
      while (wordptr != NULL)
      {
        wordptr = strtok(NULL, " ");
        i++;
      }
      break;
    }
  } 

  len = i-1;
  pssm = initialize_pssm (27,len);

  fseek(filestream, 0, SEEK_SET);

  // read lines
  while (fgets(line, LINE, filestream) != NULL)
  {
    i = 0;
    // empty lines and commentary # are ignored
    if (line[0] != '\n' && line[0] != '#')
    {
      line[strlen(line)-1] = '\0'; // remove trailing \n
      // split line at blank
      wordptr = strtok(line, " ");
      while (wordptr != NULL)
      {
          // first field of each line is character
          if (i == 0)
          {
            // if no character
            if(sscanf(wordptr, "%c", &ch) == 0)
            {
              puts("ERROR: no character found");
              fclose (filestream);
              delete_pssm(pssm);
              free(usedrow);
              return NULL;
            }
            ch = toupper(ch);
           
            if (isupper(ch) || ch == '*')
            { 
              if (ch == '*')
                ch = '[';

              // check if entry in first column is set (=> double symbol)
              if (usedrow[ch-'A'])
              {
                printf("ERROR: symbol %c used more than once in rows\n", ch);
                fclose (filestream);
                free(usedrow);
                delete_pssm(pssm);
                return NULL;
              }
              usedrow[ch-'A'] = 1;
              linecount += 1;
            }
            else 
            {
              printf("ERROR: symbol %c is not allowed\n", ch);
              fclose (filestream);
              free(usedrow);
              delete_pssm(pssm);
              return NULL;
            }

          }
          // if not first character
          else
          {
            if (sscanf(wordptr, "%d", &score) == 0)
            {
              puts("ERROR: no score value found");
              fclose (filestream);
              free(usedrow);
              delete_pssm(pssm);
              return NULL;
            }

            if (i-1 >= len)
            {
              puts("ERROR: more entries than allowed detected");
              fclose (filestream);
              free(usedrow);
              delete_pssm(pssm);
              return NULL;
            }

            pssm->matrix[ch-'A'][i-1] = score;
          }

        // read next field
        wordptr = strtok(NULL, " ");
        i++;
      }
      if (i-1 != len)
      {
        puts("ERROR: different number of entries in lines detected!");
        fclose (filestream);
        free(usedrow);
        delete_pssm(pssm);
        return NULL;
      }
    }
  }

  fclose(filestream);
  free(usedrow);
  max_pssmscore(pssm); /* calculate maximum score for each character */
  return pssm;
}

void show_pssmatrix(Pssm* pssm)
{
  int i,j,print;
  for (i = 'A'; i <= '['; i++)
  {
    print = 0;
    for (j = -1; j < pssm->n; j++)
    {
      if (j == -1 && get_pssmscore(pssm,0,i) > INT_MIN)
      {
        printf("%c", i);
        print = 1;
      }
      else if (i >= 'A' && j >= 0 && get_pssmscore(pssm,j,i) > INT_MIN)
        printf(" %3d", get_pssmscore(pssm,j,i));
      else
        ;//printf("   ");
    }
    if (print)
      printf("\n");
  }

}

#ifdef UNIT_TEST
int main(int argc, char* argv[])
{
  if (argc < 2)
  {
    puts("ERROR: no file specified");
    return 1;
  }

  Pssm* pssm = read_pssm(argv[1]);

  if (pssm == NULL)
    return 1;

  show_pssmatrix(pssm);

  delete_pssm(pssm);

  return 0;
}
#endif
